{% extends "base.html" %}

{% block content %}
<form action="{{ url_for('request_update', id=paper.id) }}" method="post">
  {{ edit_button.hidden_tag() }}
  <div class="form-group edit_button"> {{ edit_button.submit(class_='btn btn-success') }} </div>
</form>

<div class="paper_info">
  <h3>{{ paper.paper_name }}</h3>

  <table>
  <tr>
    <td>Contact author email: </td>
    <td><b> {{ paper.author_email }} </b></td>
  </tr>
  <tr>
    <td>Tool name: </td>
    <td><b>{{ paper.tool_name }}</b></td>
  </tr>
  <tr>
    <td>Description:</td>
    <td><b>{{ paper.description }}</b></td>
  </tr>
  <tr>
    <td>Link to archive:</td>
    <td><b>{{ paper.link_to_archive }}</b></td>
  </tr>
  <tr>
    <td>Cite the paper if you use the artifact:</td>
    <td><b>{{ paper.bibtex }}</b></td>
  </tr>
  <tr>
    <td>Link to public pdf:</td>
    <td><b>{{ paper.link_to_pdf }}</b></td>
  </tr>
  <tr>
    <td>Link to tool webpage:</td>
    <td><b>{{ paper.link_to_tool_webpage }}</b></td>
  </tr>
  <tr>
    <td>Link to demo:</td>
    <td><b>{{ paper.link_to_demo }}</b></td>
  </tr>
  <tr>
    <td>Tags:</td>
    <td>
      <b>
        {{ tags }}
      </b>
    </td>
  </tr>
  <tr>
    <td>Artifacts:</td>
    <td>
      <ul>
      {% for file in paper.files %}
        {% if file != 'None' %}
          <li>{{ file.filetype }}: <a href="/downloads/{{ paper.id }}/{{file.filename}}">{{ file.filename }}</a></li>
        {% endif %}
      {% endfor %}
      </ul>
    </td>
  </tr>
  </table>
</div>

<div class="feedback_form_wrap">
  <h3>Your feedback would be appreciated!</h3>

  <form action="{{ url_for('add_comment', id=paper.id) }}" method="post" class="feedback_form">
    {{ form.hidden_tag() }}
    <div class="form-group required">
        {{ form.commenter_email.label }}
        {{ form.commenter_email(size=32, class_='form-control') }}
        {% for error in form.commenter_email.errors %}
          <span style="color: red;">[{{ error }}]</span>
        {% endfor %}
    </div>
    <div class="form-group required">
        {{ form.comment.label }}
        {{ form.comment(size=32, class_='form-control') }}
        {% for error in form.comment.errors %}
          <span style="color: red;">[{{ error }}]</span>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.upvote() }}
        {{ form.upvote.label }}
    </div>
    <div class="form-group">
        {{ form.recaptcha }}
        {% for error in form.recaptcha.errors %}
            <span style="color: red;">[{{ error }}]</span>
        {% endfor %}
    </div>
    <div class="form-group">{{ form.submit(class_='btn btn-success') }}</div>

    <div class="loading">
      <img src="{{ url_for('static',filename='assets/roll.gif') }}" />
    </div>

    <div class="form_submission_msg">
    </div>
  </form>
</div>

<script>
  $(document).ready(function() {
    $('.feedback_form').submit(function (e) {
      $('.loading').show();
      $('.form-group').hide();

      var url = "{{ url_for('add_comment', id=paper.id) }}"; // send the form data here.
      $.ajax({
        type: "POST",
        url: url,
        data: $('form').serialize(), // serializes the form's elements.
        success: function (result) {
          console.log(result)  // display the returned data in the console.
          $('.loading').hide();
          $('.form_submission_msg').text(result.data.message)
        },
        failure: function (error) {
          $('.loading').hide();
          $('.form_submission_msg').text(error.data.custom_msg)
        }
      });
      e.preventDefault(); // block the traditional submission of the form.
      console.log('inside ajax');
    });
    // Inject our CSRF token into our AJAX request.
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
        }
      }
    })
  });
</script>

{% endblock %}